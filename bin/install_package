#!/usr/bin/env bash

trap 'exit' ERR
set -E

# Load OS variables. Defines DISTRIB_CODENAME.
# shellcheck source=/dev/null
source /etc/lsb-release

# usage displays a usage statement.
usage() {
    cat <<EOF
Usage: install_package PACKAGE_NAME SRC_DIRECTORY
EOF
}

# Unpack, validate the digests, and install the named package.
main() {
    local tembo_pkg arch src dest
    tembo_pkg=${1-}
    src=${2-.}

    # Maker sure we have the tembo package argument.
    if [ -z "$tembo_pkg" ]; then
        usage
        exit 2
    fi

    dest=/var/lib/postgresql/data/lib
    arch="$(dpkg --print-architecture)"
    cd "$src/$DISTRIB_CODENAME" || exit
    tar zxvf "tembo-${tembo_pkg}_${arch}.tgz" -C /tmp
    cd "/tmp/tembo-${tembo_pkg}_${arch}" || exit
    sha512sum --check --strict digests
    mkdir -p "$dest"
    cp -p --recursive --update --verbose "lib/"* "$dest/"
}

main "$@"
